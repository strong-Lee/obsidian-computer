本节将涵盖您可能遇到的常见问题及MicroK8s的一些高级维护操作。

### 7.1 常见问题排查与解决

1. **microk8s is not running / Pod CrashLoopBackOff / Failed to pull image：**
    
    > [!FAILURE] 错误现象  
    > Warning FailedCreatePodSandBox ... failed to get sandbox image "registry.k8s.io/pause:3.7" 或其他镜像拉取失败。
    
    > [!INFO] 原因  
    > 无法从默认的公共镜像仓库（如registry.k8s.io、gcr.io、docker.io）拉取镜像，通常是网络问题（防火墙、代理、DNS解析失败）。
    
    > [!TIP] 解决方法
    > 
    > - **检查网络：** 确保VM可以访问外网（ping www.baidu.com）。
    >     
    > - **配置代理（如果需要）：** 在VM中设置系统代理或Containerd代理。
    >     
    >     - **Containerd代理配置示例：**
    >         
    >         ```bash
    >         echo '[plugins."io.containerd.grpc.v1.cri".registry.configs."registry.k8s.io".mirrors]' | sudo tee -a /var/snap/microk8s/current/args/containerd-flags
    >         echo '  [plugins."io.containerd.grpc.v1.cri".registry.configs."registry.k8s.io".mirrors."registry.k8s.io"]' | sudo tee -a /var/snap/microk8s/current/args/containerd-flags
    >         echo '    endpoint = ["https://registry.aliyuncs.com/google_containers"]' | sudo tee -a /var/snap/microk8s/current/args/containerd-flags
    >         # 重启microk8s使配置生效
    >         microk8s stop && microk8s start
    >         ```
    >         这会将 registry.k8s.io 的镜像源指向阿里云的镜像服务。
    >         
    > - **手动拉取并导入：** 像您原文档中那样，使用 microk8s.ctr pull <mirror_image> 或 crictl pull 从其他源拉取，然后通过 microk8s.images import 导入。
    >     
    >     ```bash
    >     # 例如，拉取pause镜像
    >     sudo microk8s.ctr image pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.7
    >     ```
    > - **crictl工具：** crictl 是CRI (Container Runtime Interface) 兼容的容器运行时命令行工具，可以直接与Containerd通信。在某些情况下，它比 microk8s.ctr 更有用。
    >     
    >     - **安装 crictl (通常已在microk8s中，如果未安装，可手动安装)：**
    >         
    >         ```bash
    >         # 下载crictl，需要选择对应的架构 (amd64, arm64等)
    >         sudo curl -L https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.22.0/crictl-v1.22.0-linux-amd64.tar.gz -o crictl-v1.22.0-linux-amd64.tar.gz
    >         sudo tar -zxvf crictl-v1.22.0-linux-amd64.tar.gz -C /usr/local/bin
    >         crictl --version # 查看是否安装成功
    >         ```
    
    > 
    > ```bash
    > # 配置crictl使用microk8s的containerd socket (如果需要)
    >     # sudo crictl config --set runtime-endpoint=unix:///var/snap/microk8s/common/run/containerd.sock
    >     ```
    > *   **使用 `crictl` 拉取镜像：**
    >     ```bash
    >     sudo crictl pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.7
    >     ```
    > ```
    
2. **NetworkReady=false reason:NetworkPluginNotReady：**
    
    > [!FAILURE] 错误现象  
    > Network plugin returns error: cni plugin not initialized.
    
    > [!INFO] 原因  
    > K8s网络插件（如Calico）未正确启动或配置。Pod之间的网络通信依赖它。
    
    > [!TIP] 解决方法
    > 
    > - **检查Calico Pods：** kubectl get pods -n kube-system | grep calico，查看Calico Pod是否运行正常。
    >     
    > - **重新应用CNI配置：**
    >     
    >     ```bash
    >     kubectl apply -f /var/snap/microk8s/current/args/cni-network/cni.yaml
    >     ```
    >     
    >     这个YAML文件包含了MicroK8s Calico网络的默认配置。重新应用可以修复可能损坏的配置。
    >     
    > - **检查防火墙：** 确保 [[#1.4 设置防火墙规则|sudo iptables -P FORWARD ACCEPT]] 已设置。
    >     
    > - **检查IP冲突/网络配置：** 确保节点IP和Pod CIDR没有冲突。
    >     
    
3. **missing node capacity for resources: ephemeral-storage：**
    
    > [!INFO] 现象与原理
    > 
    > - **现象：** Pod请求或使用了过多的临时存储（如日志、缓存文件），超出了节点或Pod的临时存储限制。
    >     
    > - **ephemeral-storage 原理：** 临时存储指的是Pod在其生命周期内使用的可写层（容器层）和卷（emptyDir、configMap、secret等）所占用的磁盘空间。K8s可以为每个Pod设置临时存储的requests和limits。
    >     
    
    > [!TIP] 解决方法
    > 
    > - **清理不必要的日志或缓存文件。**
    >     
    > - **调整Pod的资源限制：** 在[[Deployment]] YAML中增加 ephemeral-storage 的 requests 和 limits。
    >     
    >     ```yaml
    >     spec:
    >       containers:
    >       - name: your-app
    >         resources:
    >           limits:
    >             ephemeral-storage: 5Gi # 允许使用最大5GB的临时存储
    >           requests:
    >             ephemeral-storage: 1Gi # 请求1GB临时存储
    >     ```
    >     
    > - **检查节点磁盘空间：** df -h 检查MicroK8s VM的磁盘空间是否已满。
    >     
    

### 7.2 MicroK8s高级维护与清理

MicroK8s的重置和清理操作。

1. **不卸载清除MicroK8s（软重置）：**  
    当您想清除所有部署，但保留MicroK8s本身时，可以使用 microk8s reset。
    
    ```bash
    microk8s reset
    ```
    
    > [!INFO] 目的与原理
    > 
    > - **目的：** 清除所有Kubernetes资源（Pod, Deployment, Service, PVC等），还原K8s集群到刚安装时的状态。这比手动删除所有资源更彻底和方便，特别是当集群出现严重问题时。
    >     
    > - **原理：** microk8s reset 会停止所有K8s服务，清理 /var/snap/microk8s/common 下的K8s数据目录，然后重新启动服务。这不会删除MicroK8s Snap包本身。
    >     
    
    > [!NOTE] 彻底删除所有K8s资源 (谨慎操作)  
    > 如果 microk8s reset 不够彻底，或者您想手动清理特定资源，可以使用以下命令：
    > 
    > ```bash
    > # 删除所有 Pods、Services、Deployments、ReplicaSets、StatefulSets、ConfigMaps、Secrets 等
    > sudo microk8s kubectl delete --all pods --all-namespaces
    > sudo microk8s kubectl delete --all services --all-namespaces
    > sudo microk8s kubectl delete --all deployments --all-namespaces
    > sudo microk8s kubectl delete --all replicasets --all-namespaces
    > sudo microk8s kubectl delete --all statefulsets --all-namespaces
    > # 注意：删除所有命名空间会删除其中所有资源，包括系统命名空间，除非您非常清楚后果，否则不建议执行。
    > # sudo microk8s kubectl delete --all namespaces # 非常危险，会删除所有命名空间包括 kube-system
    > sudo microk8s kubectl delete --all secrets --all-namespaces
    > sudo microk8s kubectl delete --all configmaps --all-namespaces
    > 
    > # 清理已安装的 Helm Charts (需要先获取列表)
    > sudo microk8s helm3 list --all-namespaces
    > # 获取所有安装的 charts 后，可以卸载：
    > # sudo microk8s helm3 uninstall <chart-name> --namespace <namespace>
    > 
    > # 清除 Calico 配置（如果有）
    > # sudo microk8s kubectl delete -f /etc/calico/calicoctl.cfg # 这个文件通常是calicoctl的配置，而不是集群资源
    > 
    > # 删除所有的 Docker 镜像 (MicroK8s使用Containerd，不是Docker Daemon)
    > sudo microk8s.ctr images list
    > for image in $(microk8s.ctr images list --quiet); do
    >   sudo microk8s.ctr image remove $image
    > done
    > ```
    > 
    > **重新启动 MicroK8s (如果只是重置后需要重启服务):**
    > 
    > ```bash
    > sudo systemctl restart snap.microk8s.daemon-kubelet.service
    > sudo systemctl restart snap.microk8s.daemon-apiserver.service
    > ```
    > 
    
2. **彻底卸载MicroK8s：**
    
    ```bash
    sudo snap remove microk8s --purge
    # 移除别名 (snap remove --purge 理论上会处理，但有时为了彻底可以手动移除)
    # sudo rm /snap/bin/kubectl /snap/bin/helm /snap/bin/ctr /snap/bin/helm3
    ```
    
    > [!CAUTION] 注意事项  
    > --purge：删除MicroK8s的所有数据和配置，无法恢复。
    

### 7.3 其他实用命令与调试技巧

- microk8s inspect: 检查MicroK8s环境的详细状态和配置信息，并生成一份报告，非常有助于问题诊断。
    
- kubectl describe <resource_type>/<resource_name> -n <namespace>: 获取某个K8s资源的详细信息，包括事件、状态、配置等。例如 kubectl describe pod nginx-deployment-xxxx -n lida。
    
- kubectl get events -n <namespace>: 查看某个命名空间下的事件，事件通常是Pod调度失败、镜像拉取失败、OOMKill等的线索。
    
- kubectl port-forward svc/<service_name> <local_port>:<service_port> -n <namespace>: 临时将集群内部服务端口转发到本地。在调试或本地开发时非常有用。
    
    ```bash
    # 临时方案：将Ingress Controller的80端口转发到本地8080端口，用于调试
    kubectl port-forward svc/ingress-nginx-controller 8080:80 -n ingress-nginx
    # 查看正在运行的port-forward进程
    ps aux | grep "kubectl port-forward"
    # 杀死port-forward进程（替换<PID>为实际进程ID）
    kill -9 <PID>
    ```