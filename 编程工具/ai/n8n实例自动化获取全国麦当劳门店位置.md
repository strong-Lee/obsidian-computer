## Phase 1: 准备工作与概念回顾

### 1.1 获取高德地图 API Key

这个工作流的核心是调用高德地图的“关键词搜索”API。你需要先去申请一个免费的 Key。

1. 打开浏览器，访问**高德开放平台**：[https://lbs.amap.com/](https://www.google.com/url?sa=E&q=https%3A%2F%2Flbs.amap.com%2F) 。 注册并登录你的账号。
    
2. 进入**控制台**，在左侧菜单选择**“应用管理” -> “我的应用”**。
    
3. 点击**“创建新应用”**，给应用起个名字（比如 n8n-mcd-finder），选择“工具”类型。
    
4. 创建成功后，点击应用右侧的**“添加”**按钮，来为这个应用添加 Key。
    
5. 给 Key 起个名字，选择服务平台为 **"Web服务 (REST API)"**，然后提交。
    
6. 创建成功后，你就会在 Key 管理页面看到一长串字符，这就是你的 **API Key**。复制并保存好它，我们马上要用。
    

### 1.2 n8n 核心概念再理解

- **循环 (Looping):** n8n 的一个核心特性。当一个节点向上一个节点输出了**多个数据项 (Items)** 时，n8n 会自动为**每一个数据项**都执行一次这个节点。这就是 n8n 实现循环的隐式机制，非常强大。
    
- **HTTP 请求节点 (HTTP Request Node):** 这是 n8n 的“万能节点”，可以用来调用任何对外提供 REST API 的服务，比如高德地图API。
    
- **设置节点 (Set Node):** 一个数据处理节点，用来创建、修改或重组数据项。

## Phase 2: 搭建工作流

### 步骤 2.1: 手动触发与省份列表 (第一个节点)

1. **新建工作流**，点击“从头开始”。
    
2. **添加触发器：** 点击 + 号，选择**“手动触发 (Trigger Manually)”**。
    
    - 这个触发器非常适合开发和测试，它只有一个“执行工作流”按钮，点击一下，流程就开始了。
        
3. **重命名节点：** 点击节点标题，把它改成**“1. 手动开始 & 省份列表”**，方便理解。
    
4. **添加省份数据：** 我们需要把中国的省份列表作为这个节点的**输出**，这样下一个节点才能接收到并进行循环。
    
    - 点击“手动触发”节点，在右侧的 **OUTPUT (输出)** 面板，切换到 **JSON** 视图。
        
    - 点击 **“设置模拟数据 (set mock data)”**。
        
    - 在弹出的编辑器里，粘贴以下 JSON 数据。这是一个包含了所有省份名称的数组：
        
    ```json
    [
      {"province": "北京市"}, {"province": "天津市"}, {"province": "河北省"},
      {"province": "山西省"}, {"province": "内蒙古自治区"}, {"province": "辽宁省"},
      {"province": "吉林省"}, {"province": "黑龙江省"}, {"province": "上海市"},
      {"province": "江苏省"}, {"province": "浙江省"}, {"province": "安徽省"},
      {"province": "福建省"}, {"province": "江西省"}, {"province": "山东省"},
      {"province": "河南省"}, {"province": "湖北省"}, {"province": "湖南省"},
      {"province": "广东省"}, {"province": "广西壮族自治区"}, {"province": "海南省"},
      {"province": "重庆市"}, {"province": "四川省"}, {"province": "贵州省"},
      {"province": "云南省"}, {"province": "西藏自治区"}, {"province": "陕西省"},
      {"province": "甘肃省"}, {"province": "青海省"}, {"province": "宁夏回族自治区"},
      {"province": "新疆维吾尔自治区"}, {"province": "台湾省"}, {"province": "香港特别行政区"},
      {"province": "澳门特别行政区"}
    ]
    ```
    
5. **执行并固定数据：** 点击**“执行步骤”**，然后**点击图钉📌图标**，将这34个省份的数据项固定下来。

### 步骤 2.2: 调用高德 API 搜索 (第二个节点)

1. **添加新节点：** 点击第一个节点右侧的 + 号。
    
2. 在节点选择器中搜索并选择**“HTTP 请求 (HTTP Request)”**节点。
    
3. **重命名节点：** 改为**“2. 按省份搜索麦当劳”**。
    
4. **配置 HTTP 请求：**
    
    - **URL:** 这里是高德地图的 API 地址。输入：  
        https://restapi.amap.com/v3/place/text
        
    - **选项 (Options) -> 添加选项 (Add Option):** 我们需要通过 URL 参数告诉高德我们要搜索什么。
        
        - 选择 **"查询参数 (Query Parameters)"**。
            
    - **配置查询参数：**
        
        - 点击**“添加查询参数”**三次，添加以下三个参数：
            
        - **key**: 在“值”一栏，粘贴你从高德开放平台获取的 **API Key**。
            
        - **keywords**: 在“值”一栏，输入 麦当劳。
            
        - **city**: 这是动态的！点击“值”输入框，从左侧 **INPUT** 面板中，把**“1. 手动开始 & 省份列表”**节点输出的 province 字段**拖拽**进来。表达式应为 {{ $json.province }}。
            
5. **执行测试：** 点击**“执行步骤”**。因为上一个节点输出了34个省份，n8n 会自动循环34次，为每个省份都调用一次API。执行完成后，你会在右侧 **OUTPUT** 面板看到34个数据项，每个数据项都包含了对应省份的麦当劳门店搜索结果。

#### 步骤 3.1: 拆分数据 - 将每个省的门店列表展开 (Un-Nesting)

我们的目标是把每个数据项里的 pois 数组“打散”，让数组里的每一个门店都成为一个独立的 n8n 数据项。

1. **添加节点**: 在 HTTP Request 节点后添加 Item Lists 节点。
    
2. **重命名**: 改为 “3. 展开所有门店 (Split Out)”。
    
3. **配置节点**:
    
    - **操作 (Operation)**: 选择 Split Out Items (拆分项目)。
        
    - **要拆分的字段 (Field to Split Out)**: 输入 pois。这个字段名来自上一步高德 API 返回的数据。你可以从左侧的 INPUT 数据中直接点击 pois 字段，n8n 会自动填充。
        
    - **包含 (Include)**: 选择 父项数据 (Parent Data)，这样可以保留门店所属的省份信息，虽然此例中暂时不用，但这是个好习惯。
        
4. **执行步骤**: 点击 Execute step。
    

**见证奇迹的时刻！**

- **输入 (INPUT)**: 34 个数据项，每个都有一个 pois 数组。
    
- **输出 (OUTPUT)**: **几千个数据项！** (具体数量是全国麦当劳门店总数)。现在，**每一个数据项代表一个麦当劳门店**，包含了门店的 name, address, tel 等所有信息。我们成功地把“34个篮子”变成了“一堆苹果”。


#### 步骤 3.2: 精简数据 - 提取我们需要的字段

现在我们有了一份扁平化的、包含所有门店的列表，从中提取所需信息就变得非常简单了。

1. **添加节点**: 在 Item Lists 节点后添加 Edit Fields 节点 (这是 v1.x 中 Set 节点的超集和推荐替代品)。
    
2. **重命名**: 改为 “4. 提取关键信息”。
    
3. **配置节点**:
    
    - 打开 **包含所有字段 (Include All Fields)** 右边的开关，将其关闭。
        
    - 在下方的 **字段 (Fields)** 区域，点击 **添加字段 (Add Field)** 三次。
        
    - **模式 (Mode)**: 保持 设置值 (Set Key)。
        
    - **第一个字段**:
        
        - **键 (Key)**: 门店名称 (或者 name)
            
        - **值 (Value)**: 点击输入框，从左侧 INPUT 数据中找到并点击 name 字段。表达式会自动填充为 {{ $json.name }}。
            
    - **第二个字段**:
        
        - **键 (Key)**: 门店地址 (或者 address)
            
        - **值 (Value)**: 点击左侧的 address 字段。表达式为 {{ $json.address }}。
            
    - **第三个字段**:
        
        - **键 (Key)**: 联系电话 (或者 tel)
            
        - **值 (Value)**: 点击左侧的 tel 字段。表达式为 {{ $json.tel }}。
            
4. **执行步骤**: 点击 Execute step。
    

**最终输出**: 几千个数据项，每个数据项都只有三个我们精心挑选的字段：门店名称, 门店地址, 联系电话。数据干净、整洁、可用！你可以在 Table 视图中清晰地看到所有结果。


### 如何学习和深入理解？

你遇到的问题非常有代表性，这引出了一个核心的学习方法：

1. **牢记“列表转换”思想**: 把 n8n 的每一个节点都看作是一个函数，它的输入是一个**数据项列表**，输出也是一个**数据项列表**。你要做的就是思考“我需要用哪个节点，把当前这个列表，转换成我下一步需要的那个列表？”
    
    - HTTP Request (在循环中): 把 [省1, 省2, ...] 列表转换成 [省1结果, 省2结果, ...] 列表。
        
    - Item Lists (Split Out): 把 [ {pois:[...]}, {pois:[...]} ] 列表转换成 [店1, 店2, 店3, ...] 列表。
        
    - Edit Fields: 把 [ {name, addr, tel, ...}, ... ] 列表转换成 [ {名称, 地址, 电话}, ... ] 列表。

2. **精通核心数据操作节点**:
    
    - **Edit Fields (或 Set)**: **修改/添加/删除单个数据项内部的字段**。它是对“项”内部的操作。
        
    - **Item Lists**: **操作数据项列表本身**。比如拆分（Split Out）、合并（Aggregate）、去重（Remove Duplicates）、求和（Sum）等。它是对“列表”结构的操作。
        
    - **Filter**: **筛选数据项**。根据条件保留或丢弃某些数据项，改变列表的长度。
        
    - **Code**: **终极武器**。当以上节点都无法满足你复杂的数据转换需求时，可以用 JavaScript 在 Code 节点里为所欲为。比如，当高德 API 需要翻页时，你就需要在 Code 节点里写一个循环来处理。
这个例子如果只做一次，你手动去搜、去复制粘贴，也许真的比搭建一个 n8n 工作流要快。但 n8n 的威力体现在 **自动化、可重复性和集成性** 上。

3. **自动化 (Automation)**:
    
    - **定时执行**: 你可以加一个 Cron (定时任务) 节点，让这个工作流在**每个月1号凌晨**自动运行一次，获取最新的全国麦当劳门店列表。你睡觉的时候，n8n 就在为你工作。
        
    - **实时触发**: 假设你做一个网站，用户输入一个品牌（如“星巴克”），点击按钮后，这个请求可以发给 n8n 的 Webhook 节点，n8n **实时**地去高德查询，然后把干净的数据返回给你的网站显示。
        
4. **可重复性 (Repeatability)**:
    
    - 今天查麦当劳，明天你想查肯德基、星巴克、7-11便利店呢？你只需要复制这个工作流，把 HTTP Request 节点里的关键词从“麦当劳”改成“肯德基”，点击执行，一分钟内就能得到全国肯德基的数据。手动操作，你需要把34个省份再搜一遍。
        
5. **集成性 (Integration) - 这才是 n8n 的核心价值！**
    
    - 你获取完数据后，想做什么？只是看看吗？不。n8n 可以让你**接着做**：
        
        - **存入数据库**: 把几千家门店信息自动写入你的 MySQL, PostgreSQL 数据库。
            
        - **存入在线表格**: 自动将所有门店追加到一张 Google Sheets 或 Airtable 表格里，方便团队协作查看。
            
        - **发送通知**: 当任务完成后，自动通过 Slack, Telegram, Discord 或企业微信机器人发一条消息：“报告老板，全国麦当劳门店数据已更新完毕，请在Google Sheet中查阅。”
            
        - **数据可视化**: 将数据发送到 Grafana 或其他BI工具，自动生成一张门店分布地图。
            

**结论**：n8n 不是一个“单次任务”的效率工具，它是一个**“流程自动化”**的平台。它的价值在于**连接那些原本互不相通的App和服务，将一系列手动、繁琐、重复的操作，变成一个可以一键执行或自动触发的稳定流程。** 它不是数据筛选工具，而是**数字世界的粘合剂**。



### 步骤 2.3: 提取并重组我们想要的数据 (第三个节点)

高德 API 返回的数据很复杂，包含了很多我们不需要的信息。我们只想要门店的名称、地址和电话。

1. **添加新节点：** 点击 HTTP 请求节点右侧的 + 号。
    
2. 搜索并选择**“设置 (Set)”**节点。
    
3. **重命名节点：** 改为**“3. 提取门店关键信息”**。
    
4. **配置 Set 节点：**
    
    - **保留字段 (Keep Only Set):** 打开这个开关。我们只保留接下来要设置的新字段。
        
    - **添加值 (Add Value):**
        
        - **名称 (Name):** 输入 locations。
            
        - **值 (Value):** 这里需要用表达式来提取数据。点击 "fx" 切换到表达式模式，输入：
            
        ```
        {{ $json.pois.map(poi => ({ name: poi.name, address: poi.address, tel: poi.tel })) }}
        ```
        
        **表达式解读：**
        
        - $json.pois: 从上一步的输出中，获取 pois 这个数组（它包含了所有门店信息）。
            
        - .map(...): 这是一个 JavaScript 数组方法，用来遍历 pois 数组中的每一个门店（poi）。
            
        - => ({...}): 对于每一个门店，我们创建一个新的、只包含 name、address 和 tel 这三个字段的对象。
            
5. **执行测试：** 点击“执行步骤”。现在，输出的数据项被清理得非常干净，每个数据项里只有一个 locations 数组，数组里是结构化的门店信息。
    

#### 步骤 2.4: 整合所有数据 (第四个节点)

现在我们有34个数据项，每个都包含一个省的门店列表。我们需要把它们合并成一个最终的大列表。

1. **添加新节点：** 点击 Set 节点右侧的 + 号。
    
2. 搜索并选择**“项目列表操作 (Item Lists)”**节点。（这个节点在原文中可能叫别名，但功能是操作列表）
    
3. **重命名节点：** 改为**“4. 合并所有省份结果”**。
    
4. **配置节点：**
    
    - **操作 (Operation):** 选择 **“合并所有项为一个 (Aggregate all items into one)”**。
        
5. **执行测试：** 点击“执行步骤”。这次，你会看到 **OUTPUT** 面板里**只有一个数据项**了！这个数据项里面包含了之前所有34个数据项的数据，是一个巨大的数组。
    

**大功告成！** 你已经成功创建了一个可以抓取全国麦当劳门店数据的工作流！你可以在最后一个节点的输出里，以 JSON 或 Table 视图查看所有门店的名称、地址和电话。

这份重写的教程，不仅复制了原文的操作，更重要的是融入了你在之前学习中掌握的“重命名节点”、“固定数据”、“理解循环”等最佳实践，希望对你的 n8n 之旅有更大的帮助！