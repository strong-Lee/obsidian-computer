#### **操作一: 创建并初始化websocket-gateway项目**

1. **复制项目**: 将一个已有的、干净的Hyperf 2.2项目完整复制一份，并重命名为 websocket-gateway。
```bash
cp -r /path/to/your/hyperf-skeleton /path/to/websocket-gateway
cd /path/to/websocket-gateway
```

2. **安装核心依赖**: 进入项目目录，使用Composer安装WebSocket服务所需的核心组件。
```bash
# WebSocket Server 支持
composer require hyperf/websocket-server

# Redis 客户端，用于Pub/Sub和状态存储
composer require hyperf/redis
```
3. **清理无关代码**: 删除新项目中与网关功能无关的Controller, Service, Model等，保持项目整洁。
#### **操作二: 部署基础HTTP服务到K8s**
目标：先让项目作为一个普通的HTTP服务在K8s中跑起来，验证部署流程。

1. **准备 websocket-gateway-deployment.yaml**: 创建一个部署文件，它定义了如何在K8s中运行你的应用。
2. **应用部署**:
```bash
microk8s kubectl apply -f websocket-gateway-deployment.yaml
```
3. **检查与排错**:
```bash
# 检查Pod状态，确保为 Running
microk8s kubectl get pods -n lida

# 如果状态异常（如 CrashLoopBackOff），使用以下命令排查
microk8s kubectl describe pod <pod-name> -n lida
microk8s kubectl logs <pod-name> -n lida
```
4. **(可选) 首次部署或依赖问题排查**: 如果因vendor目录问题导致Pod无法启动，可按以下步骤进入容器手动安装依赖。
```bash
# 修改deployment.yaml中的args为 ["sleep 3600;"] 并重新apply。  
# 等待Pod进入Running状态。
# 进入容器 microk8s kubectl exec -it <pod-name> -n lida -- /bin/sh。
# 在容器内执行 rm -rf vendor composer.lock && composer install。
# 安装成功后，将deployment.yaml的args改回 server:watch命令，再次apply。
```

#### **操作三: 配置Ingress并进行外部访问测试**
1. **本地hosts文件配置**: 将你的域名指向测试服务器IP。
```bash
# 在 /etc/hosts 文件末尾添加
192.168.1.19    ws-gateway.lida.debug.hbaila.com
```
2. **准备 ingress-deployment.yaml**: 创建Ingress规则，将外部流量转发到我们的服务。**注意**：一个域名(host)的所有路径规则应定义在**同一个**Ingress资源文件中，以避免冲突。
3. **应用Ingress规则并验证**:
```bash
microk8s kubectl apply -f websocket-gateway-ingress.yaml
microk8s kubectl get ingress -n lida
```
- 在浏览器中访问 http://ws-gateway.lida.debug.hbaila.com，应能看到Hyperf的欢迎页。

#### **操作四: 部署Redis并配置连接**
1. **准备 redis-deployment.yaml**: 用于部署一个单节点的、带持久化存储的Redis实例。
2. **应用部署并检查**:
```bash
microk8s kubectl apply -f redis-deployment.yaml
# 确保 redis-pvc 状态为 Bound, redis-pod 状态为 Running
microk8s kubectl get pvc,pod -n lida
```
3. **在websocket-gateway中配置连接**:
- 在 .env 文件中配置Redis地址：REDIS_HOST=redis-service
- **重要**：修改config/autoload/redis.php，为连接添加'options' => [\Redis::OPT_READ_TIMEOUT => -1]，防止subscribe超时。

```

将原来的hyperf2.2项目拷贝一份新的项目websocket-gateway
操作二：
```bash
microk8s kubectl apply -f websocket-gateway.yaml

# 检查pod是否正常
microk8s kubectl get pods -n lida

# 查看报错的原因
microk8s kubectl describe pod websocket-gateway-bf584c757-95xgd -n lida
microk8s kubectl logs -p websocket-gateway-bf584c757-95xgd -n lida

# 如果vender目录忘记安装直接复制过来也会报错，可执行下面的操作
# ... deployment.yaml ...
      command: ["/bin/sh", "-c", "--"]
      args:
        # - "/usr/bin/php /app/bin/hyperf.php server:watch;"  <-- 先注释或删除这一行
        - "sleep 3600;" # <-- 替换成这一行，让容器启动后睡1小时
          
# 应用新的yaml文件
microk8s kubectl apply -f deployment.yaml

# 等待Pod变成Running状态
microk8s kubectl get pod -n lida -w

# Pod正常运行后，进入容器的shell
microk8s kubectl exec -it <你的新pod名字> -n lida -- /bin/sh

# 在容器的shell里执行
# 先删除可能存在问题的旧vendor目录和composer.lock
rm -rf vendor composer.lock

# 设置composer国内镜像（在容器里下载会快很多）
composer config -g repo.packagist composer https://mirrors.aliyun.com/composer/

# 执行安装
composer install
```

操作三：
本地电脑配置host进行访问
```bash
# 在 /etc/hosts 文件末尾添加
192.168.1.19    ws-gateway.lida.debug.hbaila.com

# 执行ingress-deployment.yaml文件
microk8s kubectl apply -f ingress.yaml

# 检查状态
microk8s kubectl get ingress -n lida

# 浏览器访问进行测试http://ws-gateway.lida.debug.hbaila.com
```

操作四：
配置Redis服务器：
```bash
microk8s kubectl apply -f redis-deployment.yaml

microk8s kubectl get pvc -n lida
microk8s kubectl get pod -n lida
```